<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>HomePi â€” Devices</title>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600&family=Fira+Code:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c26;
    --surface3: #242432;
    --border: rgba(255,255,255,0.06);
    --border2: rgba(255,255,255,0.1);
    --text: #f0f0f8;
    --muted: #55556a;
    --accent: #e8c547;
    --green: #4ade80;
    --red: #f87171;
    --blue: #60a5fa;
    --orange: #fb923c;
  }

  body {
    background: #060609;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: 'Unbounded', sans-serif;
    color: var(--text);
  }

  .tablet {
    width: 860px;
    height: 600px;
    background: var(--bg);
    border-radius: 24px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08), 0 0 0 5px #0d0d12, 0 50px 140px rgba(0,0,0,0.9);
    overflow: hidden;
    display: grid;
    grid-template-rows: 40px 1fr;
  }

  .statusbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 22px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    font-size: 10px;
    color: var(--muted);
    font-family: 'Fira Code', monospace;
    letter-spacing: 0.05em;
  }

  .statusbar .time { color: var(--text); font-size: 11px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); transition: all 0.4s; }
  .dot.live { background: var(--green); box-shadow: 0 0 8px var(--green); }

  .layout {
    display: grid;
    grid-template-columns: 160px 1fr;
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 18px 0;
  }

  .brand {
    padding: 0 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
    cursor: pointer;
  }

  .brand-name { font-size: 13px; font-weight: 600; letter-spacing: 0.08em; }
  .brand-sub { font-family: 'Fira Code', monospace; font-size: 9px; color: var(--muted); margin-top: 3px; }

  .nav {
    padding: 7px 10px;
    margin: 0 6px;
    border-radius: 8px;
    font-size: 10px;
    letter-spacing: 0.06em;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.15s;
  }

  .nav.active { background: rgba(232,197,71,0.1); color: var(--accent); }
  .nav:hover:not(.active) { background: var(--surface2); color: var(--text); }
  .nav-icon { font-size: 13px; width: 16px; text-align: center; }

  /* Main */
  .main {
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: var(--bg);
  }

  .main::-webkit-scrollbar { width: 3px; }
  .main::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  /* Header row */
  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    animation: fadeUp 0.35s ease both;
  }

  .page-title {
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
  }

  /* Add device button */
  .add-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(232,197,71,0.12);
    border: 1px solid rgba(232,197,71,0.3);
    border-radius: 10px;
    padding: 8px 16px;
    font-family: 'Unbounded', sans-serif;
    font-size: 10px;
    letter-spacing: 0.08em;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-btn:hover { background: rgba(232,197,71,0.2); }
  .add-btn.scanning { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.3); color: var(--green); }

  /* Scanning banner */
  .scan-banner {
    background: rgba(74,222,128,0.06);
    border: 1px solid rgba(74,222,128,0.2);
    border-radius: 12px;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    animation: fadeUp 0.3s ease both;
  }

  .scan-banner.hidden { display: none; }

  .scan-pulse {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 2px solid var(--green);
    flex-shrink: 0;
    position: relative;
    animation: scanPulse 1.5s ease-in-out infinite;
  }

  .scan-pulse::after {
    content: '';
    position: absolute;
    inset: 3px;
    border-radius: 50%;
    background: var(--green);
    opacity: 0.3;
  }

  @keyframes scanPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.15); opacity: 0.7; }
  }

  .scan-text { flex: 1; }
  .scan-title { font-size: 11px; color: var(--green); margin-bottom: 3px; }
  .scan-sub { font-family: 'Fira Code', monospace; font-size: 9px; color: var(--muted); }

  .scan-timer {
    font-family: 'Fira Code', monospace;
    font-size: 18px;
    font-weight: 400;
    color: var(--green);
    min-width: 40px;
    text-align: right;
  }

  .stop-btn {
    padding: 6px 12px;
    background: rgba(248,113,113,0.1);
    border: 1px solid rgba(248,113,113,0.2);
    border-radius: 8px;
    font-family: 'Unbounded', sans-serif;
    font-size: 9px;
    letter-spacing: 0.06em;
    color: var(--red);
    cursor: pointer;
    transition: all 0.15s;
  }

  .stop-btn:hover { background: rgba(248,113,113,0.2); }

  /* Device grid */
  .device-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
    animation: fadeUp 0.35s 0.05s ease both;
  }

  .device-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    display: grid;
    grid-template-columns: 44px 1fr auto;
    align-items: center;
    gap: 14px;
    transition: all 0.2s;
  }

  .device-card.new-device {
    border-color: rgba(74,222,128,0.3);
    background: rgba(74,222,128,0.04);
    animation: newDevice 0.5s ease both;
  }

  @keyframes newDevice {
    from { opacity: 0; transform: translateX(-10px); border-color: rgba(74,222,128,0.6); }
    to   { opacity: 1; transform: translateX(0); }
  }

  .device-icon {
    width: 44px; height: 44px;
    border-radius: 12px;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .device-info { min-width: 0; }

  /* Editable name */
  .device-name-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
  }

  .device-name {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.03em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .edit-btn {
    width: 22px; height: 22px;
    border-radius: 6px;
    background: var(--surface2);
    border: 1px solid var(--border2);
    display: flex; align-items: center; justify-content: center;
    font-size: 10px;
    cursor: pointer;
    flex-shrink: 0;
    opacity: 0;
    transition: all 0.15s;
    color: var(--muted);
  }

  .device-card:hover .edit-btn { opacity: 1; }

  /* Inline name editor */
  .name-input {
    background: var(--surface2);
    border: 1px solid rgba(232,197,71,0.4);
    border-radius: 6px;
    padding: 3px 8px;
    font-family: 'Unbounded', sans-serif;
    font-size: 11px;
    color: var(--text);
    outline: none;
    width: 180px;
  }

  .name-save {
    padding: 3px 10px;
    background: rgba(232,197,71,0.15);
    border: 1px solid rgba(232,197,71,0.3);
    border-radius: 6px;
    font-family: 'Unbounded', sans-serif;
    font-size: 9px;
    color: var(--accent);
    cursor: pointer;
  }

  .device-meta {
    font-family: 'Fira Code', monospace;
    font-size: 9px;
    color: var(--muted);
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .type-badge {
    font-family: 'Fira Code', monospace;
    font-size: 8px;
    padding: 2px 7px;
    border-radius: 4px;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }

  .type-light   { background: rgba(232,197,71,0.1);  color: var(--accent); }
  .type-sensor  { background: rgba(96,165,250,0.1);  color: var(--blue); }
  .type-switch  { background: rgba(74,222,128,0.1);  color: var(--green); }
  .type-contact { background: rgba(251,146,60,0.1);  color: var(--orange); }
  .type-motion  { background: rgba(167,139,250,0.1); color: #a78bfa; }
  .type-unknown { background: rgba(85,85,106,0.15);  color: var(--muted); }

  .signal {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 12px;
  }

  .signal-bar {
    width: 3px;
    border-radius: 1px;
    background: var(--surface3);
    transition: background 0.3s;
  }

  .signal-bar.active { background: var(--green); }
  .signal-bar:nth-child(1) { height: 4px; }
  .signal-bar:nth-child(2) { height: 7px; }
  .signal-bar:nth-child(3) { height: 10px; }
  .signal-bar:nth-child(4) { height: 12px; }

  /* Device actions */
  .device-actions { display: flex; gap: 8px; align-items: center; }

  .state-indicator {
    font-family: 'Fira Code', monospace;
    font-size: 9px;
    padding: 3px 9px;
    border-radius: 6px;
    letter-spacing: 0.04em;
  }

  .state-on  { background: rgba(74,222,128,0.1);  color: var(--green); }
  .state-off { background: rgba(85,85,106,0.15);  color: var(--muted); }

  .remove-btn {
    width: 32px; height: 32px;
    border-radius: 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s;
    opacity: 0;
  }

  .device-card:hover .remove-btn { opacity: 1; }
  .remove-btn:hover { background: rgba(248,113,113,0.1); border-color: rgba(248,113,113,0.3); color: var(--red); }

  /* Confirm remove overlay */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
  }

  .confirm-overlay.hidden { display: none; }

  .confirm-box {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 18px;
    padding: 28px 32px;
    max-width: 360px;
    width: 90%;
    text-align: center;
  }

  .confirm-icon { font-size: 36px; margin-bottom: 14px; }
  .confirm-title { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
  .confirm-sub { font-family: 'Fira Code', monospace; font-size: 10px; color: var(--muted); margin-bottom: 24px; line-height: 1.6; }

  .confirm-btns { display: flex; gap: 10px; justify-content: center; }

  .confirm-cancel {
    padding: 10px 24px;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    font-family: 'Unbounded', sans-serif;
    font-size: 10px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .confirm-cancel:hover { color: var(--text); }

  .confirm-remove {
    padding: 10px 24px;
    background: rgba(248,113,113,0.15);
    border: 1px solid rgba(248,113,113,0.3);
    border-radius: 10px;
    font-family: 'Unbounded', sans-serif;
    font-size: 10px;
    color: var(--red);
    cursor: pointer;
    transition: all 0.15s;
  }

  .confirm-remove:hover { background: rgba(248,113,113,0.25); }

  /* Empty state */
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    font-size: 11px;
    line-height: 1.8;
    font-family: 'Fira Code', monospace;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }
</style>
</head>
<body>

<div class="tablet">
  <div class="statusbar">
    <span class="time" id="clock">00:00</span>
    <div style="display:flex;gap:12px;align-items:center">
      <div class="dot" id="connDot"></div>
      <span id="connLabel">connecting</span>
    </div>
  </div>

  <div class="layout">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="brand" onclick="window.location.href='/index.html'">
        <div class="brand-name">HOMEPI</div>
        <div class="brand-sub" id="deviceCount">â€” devices</div>
      </div>
      <div class="nav" onclick="window.location.href='/index.html'"><span class="nav-icon">âš¡</span> DASHBOARD</div>
      <div class="nav"><span class="nav-icon">ðŸ’¡</span> LIGHTING</div>
      <div class="nav"><span class="nav-icon">ðŸŒ¡</span> CLIMATE</div>
      <div class="nav"><span class="nav-icon">ðŸ”’</span> SECURITY</div>
      <div class="nav"><span class="nav-icon">ðŸŽµ</span> MEDIA</div>
      <div class="nav active"><span class="nav-icon">ðŸ“¡</span> DEVICES</div>
    </div>

    <!-- Main -->
    <div class="main">

      <!-- Header -->
      <div class="page-header">
        <div class="page-title">Manage Devices</div>
        <div class="add-btn" id="addBtn" onclick="startPairing()">
          <span>ï¼‹</span> ADD DEVICE
        </div>
      </div>

      <!-- Scanning banner -->
      <div class="scan-banner hidden" id="scanBanner">
        <div class="scan-pulse"></div>
        <div class="scan-text">
          <div class="scan-title">SCANNING FOR DEVICES</div>
          <div class="scan-sub">Power cycle your Zigbee device to pair it</div>
        </div>
        <div class="scan-timer" id="scanTimer">2:00</div>
        <div class="stop-btn" onclick="stopPairing()">STOP</div>
      </div>

      <!-- Device list -->
      <div class="device-grid" id="deviceGrid">
        <div class="empty" id="emptyState">No devices found.<br>Tap ADD DEVICE to pair your first device.</div>
      </div>

    </div>
  </div>
</div>

<!-- Confirm remove overlay -->
<div class="confirm-overlay hidden" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon">ðŸ—‘</div>
    <div class="confirm-title">Remove Device?</div>
    <div class="confirm-sub" id="confirmText">This will remove the device from the Zigbee network.<br>You'll need to re-pair it to use it again.</div>
    <div class="confirm-btns">
      <div class="confirm-cancel" onclick="hideConfirm()">Cancel</div>
      <div class="confirm-remove" id="confirmRemoveBtn">Remove</div>
    </div>
  </div>
</div>

<script>
  const API = `http://${window.location.hostname}:3000`;
  const WS_URL = `ws://${window.location.hostname}:3001`;

  let devices = {};
  let scanInterval = null;
  let scanSeconds = 120;
  let pendingRemoveId = null;

  // Clock
  function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent =
      `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
  }
  updateClock();
  setInterval(updateClock, 10000);

  // Device type icon
  function typeIcon(type) {
    const icons = { light: 'ðŸ’¡', sensor: 'ðŸŒ¡', switch: 'ðŸ”Œ', contact: 'ðŸšª', motion: 'ðŸ‘', unknown: 'ðŸ“¡' };
    return icons[type] || 'ðŸ“¡';
  }

  // Signal bars from linkquality (0-255)
  function signalBars(lq) {
    const strength = lq ? Math.ceil((lq / 255) * 4) : 0;
    return [1,2,3,4].map(i =>
      `<div class="signal-bar ${i <= strength ? 'active' : ''}"></div>`
    ).join('');
  }

  // Render device list
  function renderDevices() {
    const grid = document.getElementById('deviceGrid');
    const empty = document.getElementById('emptyState');
    const list = Object.values(devices);

    document.getElementById('deviceCount').textContent = `${list.length} device${list.length !== 1 ? 's' : ''}`;

    if (list.length === 0) {
      empty.style.display = 'block';
      // Remove all cards
      grid.querySelectorAll('.device-card').forEach(c => c.remove());
      return;
    }

    empty.style.display = 'none';

    // Add/update cards
    list.forEach(device => {
      const existing = document.getElementById(`dev-${device.id}`);
      if (existing) {
        // Update dynamic parts only
        const statEl = existing.querySelector('.state-indicator');
        if (statEl && device.type === 'light') {
          statEl.textContent = device.state || 'â€”';
          statEl.className = `state-indicator ${device.state === 'ON' ? 'state-on' : 'state-off'}`;
        }
        const sigEl = existing.querySelector('.signal');
        if (sigEl) sigEl.innerHTML = signalBars(device.linkquality);
      } else {
        grid.appendChild(buildCard(device));
      }
    });

    // Remove stale cards
    grid.querySelectorAll('.device-card').forEach(card => {
      const id = card.id.replace('dev-', '');
      if (!devices[id]) card.remove();
    });
  }

  function buildCard(device) {
    const card = document.createElement('div');
    card.className = 'device-card';
    card.id = `dev-${device.id}`;

    const stateHtml = device.type === 'light'
      ? `<div class="state-indicator ${device.state === 'ON' ? 'state-on' : 'state-off'}">${device.state || 'â€”'}</div>`
      : device.type === 'sensor' && device.temperature !== null
      ? `<div class="state-indicator state-off" style="color:var(--blue)">${device.temperature?.toFixed(1)}Â°C</div>`
      : '';

    card.innerHTML = `
      <div class="device-icon">${typeIcon(device.type)}</div>
      <div class="device-info">
        <div class="device-name-wrap">
          <div class="device-name" id="name-${device.id}">${device.name}</div>
          <div class="edit-btn" onclick="startEdit('${device.id}')" title="Rename">âœŽ</div>
        </div>
        <div class="device-meta">
          <span class="type-badge type-${device.type}">${device.type}</span>
          <span style="color:var(--muted);font-size:9px">${device.manufacturer || ''}</span>
          <div class="signal">${signalBars(device.linkquality)}</div>
        </div>
      </div>
      <div class="device-actions">
        ${stateHtml}
        <div class="remove-btn" onclick="confirmRemove('${device.id}', '${device.name}')" title="Remove">âœ•</div>
      </div>
    `;

    return card;
  }

  // Inline rename
  function startEdit(id) {
    const device = devices[id];
    if (!device) return;
    const nameEl = document.getElementById(`name-${id}`);
    const wrap = nameEl.parentElement;

    wrap.innerHTML = `
      <input class="name-input" id="nameInput-${id}" value="${device.name}" maxlength="40">
      <div class="name-save" onclick="saveEdit('${id}')">SAVE</div>
    `;

    const input = document.getElementById(`nameInput-${id}`);
    input.focus();
    input.select();
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') saveEdit(id);
      if (e.key === 'Escape') cancelEdit(id);
    });
  }

  async function saveEdit(id) {
    const input = document.getElementById(`nameInput-${id}`);
    if (!input) return;
    const newName = input.value.trim();
    if (!newName) return;

    try {
      const res = await fetch(`${API}/devices/${id}/rename`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName })
      });
      const data = await res.json();
      if (data.success) {
        // Device ID may have changed â€” refresh
        await fetchDevices();
      }
    } catch(e) {
      cancelEdit(id);
    }
  }

  function cancelEdit(id) {
    const device = devices[id];
    if (!device) return;
    const input = document.getElementById(`nameInput-${id}`);
    if (!input) return;
    const wrap = input.parentElement;
    wrap.innerHTML = `
      <div class="device-name" id="name-${id}">${device.name}</div>
      <div class="edit-btn" onclick="startEdit('${id}')" title="Rename">âœŽ</div>
    `;
  }

  // Remove confirm
  function confirmRemove(id, name) {
    pendingRemoveId = id;
    document.getElementById('confirmText').innerHTML =
      `Remove <strong style="color:var(--text)">${name}</strong> from the network?<br>You'll need to re-pair it to use it again.`;
    document.getElementById('confirmRemoveBtn').onclick = () => removeDevice(id);
    document.getElementById('confirmOverlay').classList.remove('hidden');
  }

  function hideConfirm() {
    document.getElementById('confirmOverlay').classList.add('hidden');
    pendingRemoveId = null;
  }

  async function removeDevice(id) {
    hideConfirm();
    try {
      await fetch(`${API}/devices/${id}`, { method: 'DELETE' });
      delete devices[id];
      renderDevices();
    } catch(e) {}
  }

  // Pairing
  async function startPairing() {
    try {
      await fetch(`${API}/pairing/start`, { method: 'POST' });
      document.getElementById('scanBanner').classList.remove('hidden');
      document.getElementById('addBtn').classList.add('scanning');
      document.getElementById('addBtn').innerHTML = '<span>â—‰</span> SCANNING...';

      scanSeconds = 120;
      updateTimer();
      scanInterval = setInterval(() => {
        scanSeconds--;
        updateTimer();
        if (scanSeconds <= 0) stopPairing();
      }, 1000);
    } catch(e) {}
  }

  async function stopPairing() {
    clearInterval(scanInterval);
    scanInterval = null;
    document.getElementById('scanBanner').classList.add('hidden');
    document.getElementById('addBtn').classList.remove('scanning');
    document.getElementById('addBtn').innerHTML = '<span>ï¼‹</span> ADD DEVICE';
    try {
      await fetch(`${API}/pairing/stop`, { method: 'POST' });
    } catch(e) {}
  }

  function updateTimer() {
    const m = Math.floor(scanSeconds / 60);
    const s = (scanSeconds % 60).toString().padStart(2, '0');
    document.getElementById('scanTimer').textContent = `${m}:${s}`;
  }

  // Fetch devices
  async function fetchDevices() {
    try {
      const res = await fetch(`${API}/devices`);
      const data = await res.json();
      devices = {};
      data.forEach(d => devices[d.id] = d);
      renderDevices();
      setStatus(true);
    } catch(e) {
      setStatus(false);
    }
  }

  function setStatus(ok) {
    document.getElementById('connDot').className = 'dot' + (ok ? ' live' : '');
    document.getElementById('connLabel').textContent = ok ? 'live' : 'offline';
  }

  // WebSocket â€” highlight new devices when they join during pairing
  function connectWS() {
    const ws = new WebSocket(WS_URL);
    ws.onmessage = (e) => {
      try {
        const { deviceId, state } = JSON.parse(e.data);
        const isNew = !devices[deviceId];
        devices[deviceId] = { ...devices[deviceId], ...state, id: deviceId };
        renderDevices();
        if (isNew) {
          const card = document.getElementById(`dev-${deviceId}`);
          if (card) card.classList.add('new-device');
        }
      } catch(e) {}
    };
    ws.onclose = () => setTimeout(connectWS, 3000);
    ws.onerror = () => ws.close();
  }

  fetchDevices();
  connectWS();
  setInterval(fetchDevices, 15000);
</script>
</body>
</html>
