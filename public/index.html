<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>HomePi</title>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600&family=Fira+Code:wght@300;400&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c26;
    --surface3: #242432;
    --border: rgba(255,255,255,0.06);
    --border2: rgba(255,255,255,0.1);
    --text: #f0f0f8;
    --muted: #55556a;
    --accent: #e8c547;
    --green: #4ade80;
    --red: #f87171;
    --blue: #60a5fa;
    --orange: #fb923c;
  }

  body {
    background: #060609;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: 'Unbounded', sans-serif;
    color: var(--text);
  }

  .tablet {
    width: 860px;
    height: 600px;
    background: var(--bg);
    border-radius: 24px;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08), 0 0 0 5px #0d0d12, 0 50px 140px rgba(0,0,0,0.9);
    overflow: hidden;
    display: grid;
    grid-template-rows: 40px 1fr;
  }

  .statusbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 22px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    font-size: 10px;
    color: var(--muted);
    font-family: 'Fira Code', monospace;
    letter-spacing: 0.05em;
  }

  .statusbar .time { color: var(--text); font-size: 11px; }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted); transition: all 0.4s; }
  .dot.live { background: var(--green); box-shadow: 0 0 8px var(--green); }

  .layout {
    display: grid;
    grid-template-columns: 160px 1fr;
    overflow: hidden;
  }

  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 18px 0;
  }

  .brand {
    padding: 0 16px 16px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
    cursor: pointer;
  }

  .brand-name { font-size: 13px; font-weight: 600; letter-spacing: 0.08em; }
  .brand-sub { font-family: 'Fira Code', monospace; font-size: 9px; color: var(--muted); margin-top: 3px; }

  .nav {
    padding: 7px 10px;
    margin: 0 6px;
    border-radius: 8px;
    font-size: 10px;
    letter-spacing: 0.06em;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.15s;
  }

  .nav.active { background: rgba(232,197,71,0.1); color: var(--accent); }
  .nav:hover:not(.active) { background: var(--surface2); color: var(--text); }
  .nav-icon { font-size: 13px; width: 16px; text-align: center; }

  .main {
    overflow-y: auto;
    padding: 18px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    background: var(--bg);
  }

  .main::-webkit-scrollbar { width: 3px; }
  .main::-webkit-scrollbar-thumb { background: var(--surface3); border-radius: 3px; }

  /* Stat cards row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    animation: fadeUp 0.3s ease both;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
  }

  .stat-label { font-family: 'Fira Code', monospace; font-size: 8px; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-bottom: 8px; }
  .stat-value { font-size: 22px; font-weight: 600; line-height: 1; margin-bottom: 4px; }
  .stat-sub { font-family: 'Fira Code', monospace; font-size: 8px; color: var(--muted); }
  .stat-accent { color: var(--accent); }
  .stat-green  { color: var(--green); }
  .stat-blue   { color: var(--blue); }
  .stat-orange { color: var(--orange); }

  /* Middle row: lights + security */
  .mid-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    animation: fadeUp 0.3s 0.05s ease both;
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .panel-title { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }

  .panel-link {
    font-family: 'Fira Code', monospace;
    font-size: 8px;
    color: var(--accent);
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.15s;
  }

  .panel-link:hover { opacity: 1; }

  /* Light rows in panel */
  .light-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    transition: all 0.2s;
  }

  .light-row:last-child { border-bottom: none; padding-bottom: 0; }
  .light-row:first-child { padding-top: 0; }

  .light-row-icon {
    width: 30px; height: 30px;
    border-radius: 8px;
    background: var(--surface2);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    transition: all 0.3s;
  }

  .light-row.on .light-row-icon {
    background: rgba(232,197,71,0.12);
  }

  .light-row-name { flex: 1; font-size: 10px; font-weight: 400; }
  .light-row-state {
    font-family: 'Fira Code', monospace;
    font-size: 8px;
    padding: 2px 8px;
    border-radius: 4px;
  }

  .light-row.on  .light-row-state { background: rgba(232,197,71,0.1);  color: var(--accent); }
  .light-row.off .light-row-state { background: rgba(85,85,106,0.15);  color: var(--muted); }

  .toggle-sm {
    width: 30px; height: 17px;
    border-radius: 9px;
    background: var(--surface3);
    position: relative;
    cursor: pointer;
    border: 1px solid var(--border2);
    flex-shrink: 0;
    transition: background 0.2s;
  }

  .toggle-sm.on { background: rgba(232,197,71,0.25); border-color: rgba(232,197,71,0.4); }

  .toggle-sm-knob {
    width: 11px; height: 11px;
    border-radius: 50%;
    background: var(--muted);
    position: absolute;
    top: 2px; left: 2px;
    transition: all 0.2s;
  }

  .toggle-sm.on .toggle-sm-knob { left: 15px; background: var(--accent); }

  /* Security panel mock rows */
  .sec-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
  }

  .sec-row:last-child { border-bottom: none; padding-bottom: 0; }
  .sec-row:first-child { padding-top: 0; }
  .sec-row-icon { font-size: 14px; width: 20px; text-align: center; flex-shrink: 0; }
  .sec-row-name { flex: 1; font-size: 10px; }

  .sec-badge {
    font-family: 'Fira Code', monospace;
    font-size: 8px;
    padding: 2px 8px;
    border-radius: 4px;
  }

  .sec-locked  { background: rgba(74,222,128,0.1);  color: var(--green); }
  .sec-open    { background: rgba(248,113,113,0.1);  color: var(--red); }
  .sec-closed  { background: rgba(85,85,106,0.15);  color: var(--muted); }
  .sec-live    { background: rgba(96,165,250,0.1);   color: var(--blue); }

  /* Bottom row: climate + activity */
  .bot-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    animation: fadeUp 0.3s 0.1s ease both;
  }

  /* Climate mock */
  .climate-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
    font-size: 10px;
  }

  .climate-row:last-child { border-bottom: none; }
  .climate-row:first-child { padding-top: 0; }

  .climate-val {
    font-family: 'Fira Code', monospace;
    font-size: 11px;
    font-weight: 400;
  }

  .climate-val.live { color: var(--blue); }
  .climate-val.mock { color: var(--muted); }

  /* Activity feed mock */
  .activity-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
  }

  .activity-item:last-child { border-bottom: none; }
  .activity-item:first-child { padding-top: 0; }

  .activity-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
    margin-top: 3px;
  }

  .activity-dot.recent { background: var(--green); }

  .activity-text { font-family: 'Fira Code', monospace; font-size: 8px; color: var(--muted); line-height: 1.5; }
  .activity-text strong { color: var(--text); font-weight: 400; }
  .activity-time { font-size: 7px; color: var(--surface3); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="tablet">
  <div class="statusbar">
    <span class="time" id="clock">00:00</span>
    <div style="display:flex;gap:10px;align-items:center">
      <span id="dateLabel" style="color:var(--muted)"></span>
      <div class="dot" id="connDot"></div>
      <span id="connLabel">connecting</span>
    </div>
  </div>

  <div class="layout">
    <div class="sidebar">
      <div class="brand" onclick="window.location.href='/idle.html'">
        <div class="brand-name">HOMEPI</div>
        <div class="brand-sub" id="lightsOnLabel">‚Äî lights on</div>
      </div>
      <div class="nav active"><span class="nav-icon">‚ö°</span> DASHBOARD</div>
      <div class="nav" onclick="window.location.href='/lighting.html'"><span class="nav-icon">üí°</span> LIGHTING</div>
      <div class="nav"><span class="nav-icon">üå°</span> CLIMATE</div>
      <div class="nav"><span class="nav-icon">üîí</span> SECURITY</div>
      <div class="nav"><span class="nav-icon">üéµ</span> MEDIA</div>
      <div class="nav" onclick="window.location.href='/devices.html'"><span class="nav-icon">üì°</span> DEVICES</div>
    </div>

    <div class="main">

      <!-- Stats row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">Lights On</div>
          <div class="stat-value stat-accent" id="statLightsOn">0</div>
          <div class="stat-sub" id="statLightsSub">of 0 total</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Temperature</div>
          <div class="stat-value stat-blue" id="statTemp">‚Äî</div>
          <div class="stat-sub" id="statTempSub">no sensor</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Security</div>
          <div class="stat-value stat-green">‚óè</div>
          <div class="stat-sub">all clear</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Devices</div>
          <div class="stat-value stat-orange" id="statDevices">0</div>
          <div class="stat-sub">online</div>
        </div>
      </div>

      <!-- Mid row -->
      <div class="mid-row">

        <!-- Lights panel (real data) -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Lighting</div>
            <div class="panel-link" onclick="window.location.href='/lighting.html'">MANAGE ‚Üí</div>
          </div>
          <div id="lightsPanel">
            <div style="font-family:'Fira Code',monospace;font-size:9px;color:var(--muted);padding:8px 0">No lights paired</div>
          </div>
        </div>

        <!-- Security panel (mock) -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Security</div>
            <div class="panel-link">VIEW ‚Üí</div>
          </div>
          <div class="sec-row"><span class="sec-row-icon">üö™</span><span class="sec-row-name">Front Door</span><span class="sec-badge sec-locked">Locked</span></div>
          <div class="sec-row"><span class="sec-row-icon">ü™ü</span><span class="sec-row-name">Back Window</span><span class="sec-badge sec-closed">Closed</span></div>
          <div class="sec-row"><span class="sec-row-icon">üì∑</span><span class="sec-row-name">Entrance Cam</span><span class="sec-badge sec-live">Live</span></div>
          <div class="sec-row"><span class="sec-row-icon">üöó</span><span class="sec-row-name">Garage</span><span class="sec-badge sec-closed">Closed</span></div>
        </div>
      </div>

      <!-- Bottom row -->
      <div class="bot-row">

        <!-- Climate panel (real sensor + mock) -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Climate</div>
            <div class="panel-link">VIEW ‚Üí</div>
          </div>
          <div class="climate-row"><span>Temperature</span><span class="climate-val live" id="climateTemp">‚Äî</span></div>
          <div class="climate-row"><span>Humidity</span><span class="climate-val live" id="climateHumidity">‚Äî</span></div>
          <div class="climate-row"><span>Thermostat</span><span class="climate-val mock">21¬∞C</span></div>
          <div class="climate-row"><span>Air Quality</span><span class="climate-val mock">Good</span></div>
        </div>

        <!-- Activity feed (mock + real events via WS) -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Recent Activity</div>
          </div>
          <div id="activityFeed">
            <div class="activity-item"><div class="activity-dot"></div><div class="activity-text"><strong>System started</strong><br>HomePi online</div></div>
            <div class="activity-item"><div class="activity-dot"></div><div class="activity-text">Waiting for<br>device events...</div></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const API = `http://${window.location.hostname}:3000`;
  const WS_URL = `ws://${window.location.hostname}:3001`;

  let devices = {};
  const activity = [];

  function updateClock() {
    const now = new Date();
    document.getElementById('clock').textContent =
      `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    document.getElementById('dateLabel').textContent =
      `${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
  }
  updateClock();
  setInterval(updateClock, 10000);

  function setStatus(ok) {
    document.getElementById('connDot').className = 'dot' + (ok ? ' live' : '');
    document.getElementById('connLabel').textContent = ok ? 'live' : 'offline';
  }

  function render() {
    const all    = Object.values(devices);
    const lights  = all.filter(d => d.type === 'light');
    const sensors = all.filter(d => d.type === 'sensor');
    const onCount = lights.filter(d => d.state === 'ON').length;

    // Stats
    document.getElementById('statLightsOn').textContent = onCount;
    document.getElementById('statLightsSub').textContent = `of ${lights.length} total`;
    document.getElementById('statDevices').textContent = all.length;
    document.getElementById('lightsOnLabel').textContent = `${onCount} light${onCount !== 1 ? 's' : ''} on`;

    // Sensor stats
    const sensor = sensors.find(s => s.temperature !== null);
    if (sensor) {
      document.getElementById('statTemp').textContent = `${sensor.temperature.toFixed(1)}¬∞`;
      document.getElementById('statTempSub').textContent = sensor.name.toLowerCase();
      document.getElementById('climateTemp').textContent = `${sensor.temperature.toFixed(1)}¬∞C`;
      document.getElementById('climateHumidity').textContent =
        sensor.humidity !== null ? `${Math.round(sensor.humidity)}%` : '‚Äî';
    }

    // Lights panel
    const panel = document.getElementById('lightsPanel');
    if (lights.length === 0) {
      panel.innerHTML = `<div style="font-family:'Fira Code',monospace;font-size:9px;color:var(--muted);padding:8px 0">No lights paired</div>`;
    } else {
      panel.innerHTML = lights.map(l => `
        <div class="light-row ${l.state === 'ON' ? 'on' : 'off'}">
          <div class="light-row-icon">üí°</div>
          <div class="light-row-name">${l.name}</div>
          <div class="light-row-state">${l.state === 'ON' ? 'ON' : 'OFF'}</div>
          <div class="toggle-sm ${l.state === 'ON' ? 'on' : ''}" onclick="toggleLight('${l.id}')">
            <div class="toggle-sm-knob"></div>
          </div>
        </div>
      `).join('');
    }
  }

  function toggleLight(id) {
    const d = devices[id];
    if (!d) return;
    const newState = d.state === 'ON' ? 'OFF' : 'ON';
    devices[id].state = newState;
    render();
    addActivity(`${d.name} turned ${newState}`, true);
    fetch(`${API}/devices/${id}/command`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ state: newState })
    }).catch(() => {});
  }

  function addActivity(text, recent = false) {
    const now = new Date();
    const time = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
    activity.unshift({ text, time, recent });
    if (activity.length > 5) activity.pop();
    renderActivity();
  }

  function renderActivity() {
    document.getElementById('activityFeed').innerHTML = activity.map((a, i) => `
      <div class="activity-item">
        <div class="activity-dot ${i === 0 && a.recent ? 'recent' : ''}"></div>
        <div class="activity-text"><strong>${a.text}</strong><br><span class="activity-time">${a.time}</span></div>
      </div>
    `).join('');
  }

  async function fetchDevices() {
    try {
      const res = await fetch(`${API}/devices`);
      const data = await res.json();
      data.forEach(d => { devices[d.id] = { ...devices[d.id], ...d }; });
      render();
      setStatus(true);
    } catch(e) {
      setStatus(false);
    }
  }

  function connectWS() {
    const ws = new WebSocket(WS_URL);
    ws.onmessage = (e) => {
      try {
        const { deviceId, state } = JSON.parse(e.data);
        const prev = devices[deviceId];
        devices[deviceId] = { ...prev, ...state, id: deviceId };
        if (prev && prev.state !== state.state && state.state) {
          addActivity(`${devices[deviceId].name || deviceId} ‚Üí ${state.state}`, true);
        }
        render();
      } catch(e) {}
    };
    ws.onclose = () => setTimeout(connectWS, 3000);
    ws.onerror = () => ws.close();
  }

  addActivity('HomePi online', false);
  fetchDevices();
  connectWS();
  setInterval(fetchDevices, 15000);
</script>
</body>
</html>
