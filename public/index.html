<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HomePi</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Playfair+Display:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0f14;
    --surface: #1a1a24;
    --surface2: #22222f;
    --border: rgba(255,255,255,0.07);
    --text: #e8e8f0;
    --muted: #6b6b80;
    --accent: #f0a500;
    --accent2: #4fc3f7;
    --green: #69db7c;
    --red: #ff6b6b;
    --shadow: rgba(0,0,0,0.4);
  }

  body {
    background: #07070d;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
  }

  /* Tablet frame */
  .tablet {
    width: 820px;
    height: 580px;
    background: #1c1c22;
    border-radius: 28px;
    box-shadow:
      0 0 0 2px #2a2a38,
      0 0 0 6px #111118,
      0 40px 120px rgba(0,0,0,0.8),
      inset 0 1px 0 rgba(255,255,255,0.06);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Status bar */
  .statusbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 24px 6px;
    font-size: 12px;
    color: var(--muted);
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .statusbar .time {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    color: var(--text);
  }

  .statusbar .icons { display: flex; gap: 10px; align-items: center; font-size: 11px; }

  .connection-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.4s;
  }
  .connection-dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }

  /* Layout */
  .app {
    display: grid;
    grid-template-columns: 180px 1fr;
    flex: 1;
    overflow: hidden;
    background: var(--bg);
  }

  /* Sidebar */
  .sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 20px 0;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .home-label {
    padding: 0 18px 14px;
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    color: var(--text);
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }

  .home-label small {
    display: block;
    font-family: 'DM Sans', sans-serif;
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 18px;
    font-size: 13px;
    color: var(--muted);
    cursor: pointer;
    margin: 0 8px;
    border-radius: 10px;
    transition: all 0.2s;
  }

  .nav-item.active { background: rgba(240,165,0,0.12); color: var(--accent); }
  .nav-item:hover:not(.active) { background: var(--surface2); color: var(--text); }

  .sidebar-bottom {
    margin-top: auto;
    padding: 14px 16px;
    border-top: 1px solid var(--border);
  }

  .api-status {
    background: var(--surface2);
    border-radius: 12px;
    padding: 12px;
    font-size: 11px;
  }

  .api-status .status-row {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--muted);
  }

  .api-status .status-row.ok { color: var(--green); }
  .api-status .status-row.err { color: var(--red); }

  /* Main content */
  .main {
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .main::-webkit-scrollbar { width: 4px; }
  .main::-webkit-scrollbar-track { background: transparent; }
  .main::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 4px; }

  .section-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 10px;
  }

  /* Stats row */
  .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
  }

  .stat-card .label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 6px; }
  .stat-card .value { font-size: 22px; font-family: 'Playfair Display', serif; color: var(--text); line-height: 1; }
  .stat-card .value span { font-size: 11px; font-family: 'DM Sans', sans-serif; color: var(--muted); margin-left: 2px; }
  .stat-card .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 6px; }

  /* Scene buttons */
  .scenes { display: flex; gap: 8px; flex-wrap: wrap; }

  .scene-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 11px;
    color: var(--muted);
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
  }

  .scene-btn.active { background: rgba(240,165,0,0.15); border-color: rgba(240,165,0,0.3); color: var(--accent); }
  .scene-btn:hover:not(.active) { color: var(--text); border-color: rgba(255,255,255,0.14); }

  /* Lights grid */
  .lights-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }

  .light-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
    user-select: none;
  }

  .light-card::before {
    content: '';
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.25s;
    border-radius: 14px;
    background: radial-gradient(circle at top right, rgba(240,200,80,0.12), transparent 70%);
  }

  .light-card.on::before { opacity: 1; }
  .light-card:hover { border-color: rgba(255,255,255,0.14); transform: translateY(-1px); }
  .light-card.loading { opacity: 0.6; pointer-events: none; }

  .light-icon {
    font-size: 22px;
    margin-bottom: 10px;
    display: block;
    filter: grayscale(1) opacity(0.4);
    transition: filter 0.3s;
  }

  .light-card.on .light-icon { filter: none; text-shadow: 0 0 16px rgba(255,200,80,0.6); }
  .light-card .room { font-size: 12px; font-weight: 500; color: var(--text); margin-bottom: 2px; }
  .light-card .status { font-size: 10px; color: var(--muted); }
  .light-card.on .status { color: var(--accent); }

  /* Toggle */
  .toggle {
    position: absolute;
    top: 12px; right: 12px;
    width: 28px; height: 16px;
    background: var(--surface2);
    border-radius: 8px;
    transition: background 0.25s;
  }

  .toggle::after {
    content: '';
    position: absolute;
    width: 10px; height: 10px;
    background: var(--muted);
    border-radius: 50%;
    top: 3px; left: 3px;
    transition: all 0.25s;
  }

  .light-card.on .toggle { background: rgba(240,165,0,0.3); }
  .light-card.on .toggle::after { background: var(--accent); left: 15px; }

  /* Brightness */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 11px;
    color: var(--muted);
    margin-top: 6px;
  }

  .slider {
    flex: 1;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    cursor: pointer;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 12px; height: 12px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(240,165,0,0.5);
  }

  /* Bottom row */
  .bottom-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  .device-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
  }

  .device-card h4 { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 12px; }

  .device-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12px;
  }

  .device-item:last-child { border-bottom: none; padding-bottom: 0; }

  .device-item .name { color: var(--text); display: flex; align-items: center; gap: 8px; }

  .badge {
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 20px;
    font-weight: 500;
  }

  .badge.on { background: rgba(105,219,124,0.15); color: var(--green); }
  .badge.off { background: rgba(107,107,128,0.15); color: var(--muted); }
  .badge.alert { background: rgba(255,107,107,0.15); color: var(--red); }

  /* Animations */
  .light-card { animation: fadeUp 0.4s ease both; }
  .light-card:nth-child(1) { animation-delay: 0.05s; }
  .light-card:nth-child(2) { animation-delay: 0.1s; }
  .light-card:nth-child(3) { animation-delay: 0.15s; }
  .light-card:nth-child(4) { animation-delay: 0.2s; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .brightness-row { margin-top: 10px; }
</style>
</head>
<body>

<div class="tablet">
  <div class="statusbar">
    <div class="time" id="clock">00:00</div>
    <div class="icons">
      <div class="connection-dot" id="connDot"></div>
      <span id="connLabel">Connecting...</span>
      <span>üîã 100%</span>
    </div>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="home-label">
        HomePi
        <small id="activeCount">Loading...</small>
      </div>

      <div class="nav-item active">
        <span>‚ö°</span> Dashboard
      </div>
      <div class="nav-item">
        <span>üí°</span> Lighting
      </div>
      <div class="nav-item">
        <span>üå°</span> Climate
      </div>
      <div class="nav-item">
        <span>üîí</span> Security
      </div>
      <div class="nav-item">
        <span>üéµ</span> Media
      </div>
      <div class="nav-item">
        <span>‚öôÔ∏è</span> Automations
      </div>
      <div class="nav-item" onclick="window.location.href='/devices.html'" style="cursor:pointer">
        <span>üì°</span> Devices
      </div>

      <div class="sidebar-bottom">
        <div class="api-status">
          <div class="status-row" id="apiStatusRow">
            <span>‚óè</span> <span id="apiStatusText">Connecting to API...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="main">

      <!-- Stats -->
      <div>
        <div class="section-title">Overview</div>
        <div class="stats-row">
          <div class="stat-card">
            <div class="label">Active devices</div>
            <div class="value" id="statActive">‚Äî<span></span></div>
            <div class="dot" style="background: var(--green)"></div>
          </div>
          <div class="stat-card">
            <div class="label">Brightness</div>
            <div class="value" id="statBrightness">‚Äî<span>%</span></div>
            <div class="dot" style="background: var(--accent2)"></div>
          </div>
          <div class="stat-card">
            <div class="label">Devices total</div>
            <div class="value" id="statTotal">‚Äî<span></span></div>
            <div class="dot" style="background: var(--accent)"></div>
          </div>
          <div class="stat-card">
            <div class="label">API status</div>
            <div class="value" id="statApi" style="font-size:14px">‚Äî</div>
            <div class="dot" style="background: var(--green)"></div>
          </div>
        </div>
      </div>

      <!-- Scenes -->
      <div>
        <div class="section-title">Scene</div>
        <div class="scenes">
          <div class="scene-btn active">üåÖ Morning</div>
          <div class="scene-btn">‚òÄÔ∏è Day</div>
          <div class="scene-btn">üé¨ Movie</div>
          <div class="scene-btn">üåô Evening</div>
          <div class="scene-btn">üí§ Sleep</div>
          <div class="scene-btn">üéâ Party</div>
        </div>
      </div>

      <!-- Lights -->
      <div>
        <div class="section-title">Lights</div>
        <div class="lights-grid" id="lightsGrid">
          <!-- Populated by JS -->
        </div>

        <div class="brightness-row">
          <div class="slider-row">
            <span>üåë</span>
            <input type="range" class="slider" id="brightnessSlider" value="100" min="1" max="100">
            <span>‚òÄÔ∏è</span>
            <span id="brightnessVal" style="min-width: 28px; color: var(--text)">100%</span>
          </div>
        </div>
      </div>

      <!-- Bottom row -->
      <div class="bottom-row">
        <div class="device-card">
          <h4>Devices</h4>
          <div class="device-item">
            <div class="name"><span>üå°</span> Thermostat</div>
            <span class="badge off">‚Äì</span>
          </div>
          <div class="device-item">
            <div class="name"><span>üì∫</span> Living Room TV</div>
            <span class="badge off">‚Äì</span>
          </div>
          <div class="device-item">
            <div class="name"><span>ü´ß</span> Dishwasher</div>
            <span class="badge off">‚Äì</span>
          </div>
          <div class="device-item">
            <div class="name"><span>üåÄ</span> Robot Vacuum</div>
            <span class="badge off">‚Äì</span>
          </div>
        </div>

        <div class="device-card">
          <h4>Security</h4>
          <div class="device-item">
            <div class="name"><span>üö™</span> Front Door</div>
            <span class="badge on">Locked</span>
          </div>
          <div class="device-item">
            <div class="name"><span>ü™ü</span> Back Window</div>
            <span class="badge alert">Open</span>
          </div>
          <div class="device-item">
            <div class="name"><span>üì∑</span> Doorbell Cam</div>
            <span class="badge on">Live</span>
          </div>
          <div class="device-item">
            <div class="name"><span>üöó</span> Garage</div>
            <span class="badge on">Closed</span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  // --- Config ---
  const API = window.location.hostname === 'localhost'
    ? 'http://localhost:3000'
    : `http://${window.location.hostname}:3000`;
  const WS_URL = `ws://${window.location.hostname}:3001`;

  // --- Clock ---
  function updateClock() {
    const now = new Date();
    const h = now.getHours().toString().padStart(2, '0');
    const m = now.getMinutes().toString().padStart(2, '0');
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    document.getElementById('clock').textContent =
      `${h}:${m} ‚Äî ${days[now.getDay()]}, ${months[now.getMonth()]} ${now.getDate()}`;
  }
  updateClock();
  setInterval(updateClock, 10000);

  // --- State ---
  let devices = {};

  // --- Render lights ---
  function renderLights() {
    const grid = document.getElementById('lightsGrid');
    const lightDevices = Object.values(devices).filter(d => d.type === 'light');

    if (lightDevices.length === 0) {
      grid.innerHTML = `<div style="color:var(--muted);font-size:12px;grid-column:span 4;padding:10px 0">No lights found</div>`;
      return;
    }

    grid.innerHTML = lightDevices.map(device => {
      const isOn = device.state === 'ON';
      const brightness = device.brightness ? Math.round((device.brightness / 254) * 100) : 0;
      return `
        <div class="light-card ${isOn ? 'on' : ''}" data-id="${device.id}" onclick="toggleLight('${device.id}')">
          <span class="light-icon">üí°</span>
          <div class="toggle"></div>
          <div class="room">${device.name}</div>
          <div class="status">${isOn ? `On ¬∑ ${brightness}%` : 'Off'}</div>
        </div>
      `;
    }).join('');
  }

  // --- Update stats ---
  function updateStats() {
    const all = Object.values(devices);
    const lights = all.filter(d => d.type === 'light');
    const active = lights.filter(d => d.state === 'ON').length;
    const avgBrightness = active > 0
      ? Math.round(lights.filter(d => d.state === 'ON').reduce((sum, d) => sum + Math.round((d.brightness / 254) * 100), 0) / active)
      : 0;

    document.getElementById('statActive').innerHTML = `${active}<span> on</span>`;
    document.getElementById('statBrightness').innerHTML = `${avgBrightness}<span>%</span>`;
    document.getElementById('statTotal').innerHTML = `${all.length}<span> total</span>`;
    document.getElementById('statApi').textContent = '‚óè Live';
    document.getElementById('statApi').style.color = 'var(--green)';
    document.getElementById('activeCount').textContent = `${active} light${active !== 1 ? 's' : ''} on`;
  }

  // --- Toggle light ---
  async function toggleLight(id) {
    const device = devices[id];
    if (!device) return;

    const card = document.querySelector(`.light-card[data-id="${id}"]`);
    card.classList.add('loading');

    const newState = device.state === 'ON' ? 'OFF' : 'ON';

    try {
      await fetch(`${API}/devices/${id}/command`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ state: newState })
      });
    } catch (e) {
      console.error('Toggle failed', e);
      card.classList.remove('loading');
    }
  }

  // --- Brightness slider ---
  const slider = document.getElementById('brightnessSlider');
  const brightnessVal = document.getElementById('brightnessVal');
  let brightnessTimer = null;

  slider.addEventListener('input', () => {
    const val = slider.value;
    brightnessVal.textContent = val + '%';
    slider.style.background = `linear-gradient(to right, var(--accent) ${val}%, var(--surface2) ${val}%)`;

    clearTimeout(brightnessTimer);
    brightnessTimer = setTimeout(async () => {
      const lights = Object.values(devices).filter(d => d.type === 'light' && d.state === 'ON');
      for (const light of lights) {
        await fetch(`${API}/devices/${light.id}/command`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ brightness: parseInt(val) })
        });
      }
    }, 300);
  });

  // --- Fetch all devices ---
  async function fetchDevices() {
    try {
      const res = await fetch(`${API}/devices`);
      const data = await res.json();
      devices = {};
      data.forEach(d => devices[d.id] = d);
      renderLights();
      updateStats();
      setApiStatus(true);
    } catch (e) {
      setApiStatus(false);
    }
  }

  // --- API status ---
  function setApiStatus(ok) {
    const dot = document.getElementById('connDot');
    const label = document.getElementById('connLabel');
    const row = document.getElementById('apiStatusRow');
    const text = document.getElementById('apiStatusText');

    dot.className = 'connection-dot' + (ok ? ' connected' : '');
    label.textContent = ok ? 'Connected' : 'Disconnected';
    row.className = 'status-row' + (ok ? ' ok' : ' err');
    text.textContent = ok ? 'API online' : 'API unreachable';
  }

  // --- WebSocket for real-time updates ---
  function connectWebSocket() {
    const ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      console.log('WebSocket connected');
    };

    ws.onmessage = (event) => {
      try {
        const { deviceId, state } = JSON.parse(event.data);
        if (devices[deviceId]) {
          devices[deviceId] = { ...devices[deviceId], ...state };
          renderLights();
          updateStats();

          // Sync brightness slider if a light changed
          const onLights = Object.values(devices).filter(d => d.type === 'light' && d.state === 'ON');
          if (onLights.length > 0) {
            const avg = Math.round(onLights.reduce((sum, d) => sum + Math.round((d.brightness / 254) * 100), 0) / onLights.length);
            slider.value = avg;
            brightnessVal.textContent = avg + '%';
            slider.style.background = `linear-gradient(to right, var(--accent) ${avg}%, var(--surface2) ${avg}%)`;
          }
        }
      } catch (e) {}
    };

    ws.onclose = () => {
      console.log('WebSocket disconnected, retrying in 3s...');
      setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = () => ws.close();
  }

  // --- Scene buttons ---
  document.querySelectorAll('.scene-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.scene-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });

  // --- Nav ---
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      item.classList.add('active');
    });
  });

  // --- Init ---
  fetchDevices();
  connectWebSocket();
  setInterval(fetchDevices, 30000); // Re-sync every 30s as fallback
</script>
</body>
</html>
